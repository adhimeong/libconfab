package org.confab;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import org.apache.http.protocol.HttpContext;
import org.apache.http.protocol.BasicHttpContext;
import org.apache.http.protocol.HTTP;
import org.apache.http.client.protocol.ClientContext;
import org.apache.http.client.CookieStore;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.BasicCookieStore;
import org.apache.http.util.EntityUtils;
import org.apache.http.HttpResponse;
import org.apache.http.HttpEntity;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.NameValuePair;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.cookie.Cookie;

import java.util.List;
import java.util.ArrayList;
import java.util.Arrays;

import java.io.IOException;

import org.confab.AndroidHttpClient;

public class VBulletinParser {

    private AndroidHttpClient httpclient = AndroidHttpClient.newInstance("Mozilla");

    public List<Forum> parseForums(Document root, BulletinBoard parent) {
        Utilities.debug("parseForums");

        List<Forum> ret = new ArrayList<Forum>();

        // get table
        Elements forum_table = root.select("tbody[id*=collapseobj_forumbit_] tr");
        assert !forum_table.isEmpty();

        for (Element el_tr : forum_table) {
            Forum new_forum = new Forum(parent);

            // Get the table data for this row
            Elements el_tds = el_tr.select("td");
            assert !el_tds.isEmpty() : el_tr.html();

            // xbox360achievements has a lot of subforums and puts these in their own table
            // The <a>'s are picked up as children of the parent <td> so don't parse this sub-
            // tables row's seperatly
            if(!el_tds.select("td.thead").isEmpty() ||
                    el_tds.size() < 3) {
                //Utilities.debug("tr doesn't seem to have anything we want, skipping.");
                continue;
            }

            // Get the title URL
            Elements els_a = el_tds.get(1).select("a");
            assert !els_a.isEmpty() : el_tds.html();
            new_forum.url = els_a.first().attr("href");
            assert new_forum.url != null;
            Utilities.debug("new_forum.url : " + new_forum.url);

            // Get the title text
            assert els_a.first() != null;
            new_forum.title = els_a.first().text();
            assert new_forum.title != null;
            Utilities.debug("new_forum.title : " + new_forum.title);

            // Check for any subforums in remaining a elements
            els_a.remove(els_a.first()); 
            for (Element el_a : els_a) {
                Forum sub_forum = new Forum(parent);
                sub_forum.url = el_a.attr("href");
                assert sub_forum.url != null;
                sub_forum.title = el_a.text();
                assert sub_forum.title != null;
                new_forum.subForums.add(sub_forum);
                Utilities.debug("added subForum: " + sub_forum.title);
            }

            // Get num viewing the current forum
            Element el_viewing = el_tr.select(":matchesOwn((\\d+ Viewing))").first(); 
            if (el_viewing != null) {
                new_forum.numViewing = el_viewing.text();
            } else {
                new_forum.numViewing = "0";
            }
            Utilities.debug("new_forum.numViewing : " + new_forum.numViewing);

            // Get the description/message of this topic
            Element el_description = el_tds.get(1).select("div.smallfont").first();
            if (el_description != null) {
                new_forum.description = el_description.text();
            } else {
                new_forum.description = "";
            }
            Utilities.debug("new_forum.description : " + new_forum.description);

            Utilities.debug("new_forum.parent.url : " + new_forum.parent.url);

            ret.add(new_forum);
            Utilities.debug("-----");
        }
        Utilities.debug("end parseForums");
        return ret;
    }

     /**
     * Constructs and submits a POST with the appropriate parameters to login to a vbulletin.
     * @param  rootURL     Base or root URL for the site to log into 
     * @param  username    User's login name
     * @param  password    User's password
     * @return             User object initialised with a HttpContext
     */
    public User login(String rootURL, String username, String password) {
        Utilities.debug("login");

        User ret = new User(username, password);

        CookieStore cookieStore = new BasicCookieStore();
        HttpContext localContext = new BasicHttpContext();
        localContext.setAttribute(ClientContext.COOKIE_STORE, cookieStore);
        
        try {
            // set up the POST
            HttpPost httppost = new HttpPost(rootURL+"login.php");
            List <NameValuePair> nvps = new ArrayList <NameValuePair>();
            nvps.add(new BasicNameValuePair("do", "login"));
            nvps.add(new BasicNameValuePair("vb_login_username", username));
            nvps.add(new BasicNameValuePair("vb_login_password", ""));
            nvps.add(new BasicNameValuePair("s", ""));
            nvps.add(new BasicNameValuePair("securitytoken", "guest"));
            nvps.add(new BasicNameValuePair("do", "login"));
            nvps.add(new BasicNameValuePair("vb_login_md5password", Utilities.md5(password)));
            nvps.add(new BasicNameValuePair("vb_login_md5password_utf", Utilities.md5(password)));
            httppost.setEntity(new UrlEncodedFormEntity(nvps, HTTP.UTF_8));

            // execute the POST 
            Utilities.debug("Executing POST");
            HttpResponse response = httpclient.execute(httppost, localContext);
            Utilities.debug("POST response: " + response.getStatusLine());
            assert response.getStatusLine().getStatusCode() == 200;

            //TODO: store the cookies
            //http://bit.ly/e7yY5i (CookieStore javadoc)

            Utilities.printCookieStore(cookieStore);

            // confirm we are logged in 
            HttpGet httpget = new HttpGet(rootURL);
            response = httpclient.execute(httpget, localContext);
            HttpEntity entity = response.getEntity();
            Document page = Jsoup.parse(EntityUtils.toString(entity));
            EntityUtils.consume(entity);
            assert page != null;

            Utilities.debug("Checking that we are logged in..");
            Element username_box = page.select("input[name=vb_login_username]").first();
            assert username_box == null;
            Element password_box = page.select("input[name=vb_login_password]").first();
            assert password_box == null;

            // parse the user's new securitytoken
            Element el_security_token = page.select("input[name=securitytoken]").first();
            assert el_security_token != null;             
            String security_token = el_security_token.attr("value");
            assert security_token != null;
            String[] token_array = security_token.split("-");
            assert token_array.length == 2;
            ret.vb_security_token = token_array[1];
            assert ret.vb_security_token.length() == 40;
            Utilities.debug("securitytoken: " + ret.vb_security_token);

            Utilities.debug("Login seems ok");
            ret.httpContext = localContext;
        } catch (IOException e) {
            System.out.println(e);
        } 

        Utilities.debug("end login");
        return ret;
    }   

    /**
     * Parses each topic for a particular forum.
     * @param  forum        Document of html containing topics
     * @param  parent       Forum the threads belong to
     * @return              List of ForumThread objects 
     */
    public List<ForumThread> parseForumThreads(Document forum, Forum parent) {
        Utilities.debug("parseForumThreads");

        List<ForumThread> ret = new ArrayList<ForumThread>();

        // Get topic table
        Elements thread_table_tds = forum.select("tbody[id*=threadbits_forum_] td");
        if (thread_table_tds.isEmpty()) {
            Utilities.debug("It seems " + parent.url + " has no topics.");
            return ret;
        }

        // Get any stickies
        Elements stickies = thread_table_tds.select(
            "td:contains(Sticky:)  a[id*=thread_title_]");

        // Get all topics
        Elements els_a = thread_table_tds.select("a[id*=thread_title_]");
        assert !els_a.isEmpty();

        // Loop topics and grab info about each
        for (Element el_a : els_a) {
            ForumThread new_topic = new ForumThread(parent);

            // Get topic 
            new_topic.title = el_a.text();
            assert new_topic.title != null;
            Utilities.debug("new_topic.title: " + new_topic.title);

            // Check if sticky
            if (stickies.html().contains(new_topic.title)) {
                new_topic.isSticky = true; 
                Utilities.debug("new_topic.isSticky: " + new_topic.isSticky);
            } 
            
            // Get URL
            new_topic.url = el_a.attr("href");
            assert new_topic.url != null;
            Utilities.debug("new_topic.url:" + new_topic.url);

            ret.add(new_topic);        
        }

        Utilities.debug("end printForumThreads");
        return ret;
    }

    /**
     * Parses each post for a particular topic.
     * @param  html         Html containing the posts to be parsed 
     * @return              List of Post objects 
     */
    public List<Post> parsePosts(Document html, ForumThread parent) {
        Utilities.debug("Starting parsePosts");
        List<Post> ret = new ArrayList<Post>();

        // Each post should have it's own table
        Elements div_posts = html.select("div#posts");
        assert !div_posts.isEmpty();
        Elements posts_table = div_posts.select("table[id~=(post\\d+)]");
        assert !posts_table.isEmpty();

        for (Element el_post : posts_table) {
            Post new_post = new Post(parent);

            // Get post id (id=post\d+)
            new_post.id = el_post.attr("id").replace("post", "").trim();
            assert new_post.id != null;

            // Get post message 
            Elements el_message = el_post.select("div[id~=(post_message_\\d+)]");
            assert !el_message.isEmpty();
            new_post.message = el_message.first().text();
            assert new_post.message != null;
            Utilities.debug("new_post.message: " + new_post.message);

            // Get post author
            Elements el_author = el_post.select(".bigusername");
            assert !el_author.isEmpty();
            new_post.author.username = el_author.first().text();
            assert new_post.author != null;
            Utilities.debug("new_post.author: " + new_post.author);

            ret.add(new_post);
        }

        Utilities.debug("Finished parsePosts");
        return ret;
    }

    public void postForumThread(Forum targetForum, Post newPost, User user) {
        Utilities.debug("postForumThread");

        try {
            String reply_page = targetForum.rootURL() + 
                "newthread.php?do=newthread&f=" + targetForum.id;
            Utilities.debug("GET: " + reply_page);
            HttpGet httpget = new HttpGet(reply_page);
            HttpResponse response = httpclient.execute(httpget, user.httpContext);
            HttpEntity entity = response.getEntity();
            Document page = Jsoup.parse(EntityUtils.toString(entity));
            EntityUtils.consume(entity);
            assert page != null;

            // TODO: need check to make sure we're on the right page.  HttpEntity's
            // can just contain garbage and jsoup will still consume it

            // Make sure we're logged in before going any further
            Element username_box = page.select("input[name=vb_login_username]").first();
            assert username_box == null;
            Element password_box = page.select("input[name=vb_login_password]").first();
            assert password_box == null;

            // Construct POST 
            HttpPost httppost = new HttpPost(targetForum.rootURL()+"newthread.php");
            List <NameValuePair> nvps = new ArrayList <NameValuePair>();

            // TODO: fix subject
            nvps.add(new BasicNameValuePair("subject", "hello world"));
            nvps.add(new BasicNameValuePair("message", newPost.message));

            // Find the form - we can parse the rest of the needed elements from it
            Element reply_form = page.select("form[action*=newthread.php?do=postthread&f=]")
                .first();
            assert reply_form != null;
            String[] vals_array = {"s", "securitytoken", "f", "do", 
                                   "posthash", "poststarttime", "loggedinuser"};
            List<String> vals = Arrays.asList(vals_array);
            for (String val : vals) {
                Element el = reply_form.select("input[name="+val+"]").first();        
                assert el != null : val;
                nvps.add(new BasicNameValuePair(val, el.attr("value")));
            }
            httppost.setEntity(new UrlEncodedFormEntity(nvps, HTTP.UTF_8));

            // Execute the POST 
            Utilities.debug("Executing POST");
            response = httpclient.execute(httppost, user.httpContext);
            Utilities.debug("POST response: " + response.getStatusLine());
            assert response.getStatusLine().getStatusCode() == 302;
        } catch (IOException e) {
            System.out.println(e);
        }
        Utilities.debug("end postForumThread");
    }   

    public void createPost(Post replyTo, Post newPost, User user) {
        Utilities.debug("createPost");

        try {
            String reply_page = replyTo.rootURL() + "newreply.php?do=newreply&noquote=1&p=" + 
                    replyTo.id;
            HttpGet httpget = new HttpGet(reply_page);
            HttpResponse response = httpclient.execute(httpget, user.httpContext);
            HttpEntity entity = response.getEntity();
            Document page = Jsoup.parse(EntityUtils.toString(entity));
            EntityUtils.consume(entity);
            assert page != null;

            // TODO: need check to make sure we're on the right page.  HttpEntity's
            // can just contain garbage and jsoup will still consume it

            // Make sure we're logged in before going any further
            Element username_box = page.select("input[name=vb_login_username]").first();
            assert username_box == null;
            Element password_box = page.select("input[name=vb_login_password]").first();
            assert password_box == null;

            // Construct POST 
            HttpPost httppost = new HttpPost(replyTo.rootURL()+"newreply.php");
            List <NameValuePair> nvps = new ArrayList <NameValuePair>();

            // There is a title param but think it's optional..
            //nvps.add(new BasicNameValuePair("title", "");

            nvps.add(new BasicNameValuePair("message", newPost.message));

            // Find the form - we can parse the rest of the needed elements from it
            Element reply_form = page.select("form[action*=newreply.php?do=postreply&t=]").first();
            assert reply_form != null;
            String[] vals_array = {"s", "securitytoken", "do", "t", "p", "specifiedpost",
                                   "posthash", "poststarttime", "loggedinuser", "multiquoteempty"};
            List<String> vals = Arrays.asList(vals_array);
            for (String val : vals) {
                Element el = reply_form.select("input[name="+val+"]").first();        
                assert el != null : val;
                nvps.add(new BasicNameValuePair(val, el.attr("value")));
            }
            httppost.setEntity(new UrlEncodedFormEntity(nvps, HTTP.UTF_8));

            // Execute the POST 
            Utilities.debug("Executing POST");
            response = httpclient.execute(httppost, user.httpContext);
            Utilities.debug("POST response: " + response.getStatusLine());
            assert response.getStatusLine().getStatusCode() == 302;
        } catch (IOException e) {
            System.out.println(e);
        }
        Utilities.debug("end createPost");
    }
}
